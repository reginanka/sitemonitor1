name: Schedule Monitor

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    
    steps:
      # 1. –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # 2. –ù–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ Python
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      # 3. –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      # 4. –ó–∞–ø—É—Å—Ç–∏—Ç–∏ –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥
      - name: Run monitor
        env:
          API_BASE_URL: ${{ secrets.API_BASE_URL }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHANNEL_ID: ${{ secrets.TELEGRAM_CHANNEL_ID }}
          TELEGRAM_LOG_CHANNEL_ID: ${{ secrets.TELEGRAM_LOG_CHANNEL_ID }}
        run: python monitor.py
      
      # 5. –ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏ (—è–∫—â–æ –≤–æ–Ω–∏ —î)
      - name: Commit changes
        if: always()
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add data/ images/ 2>/dev/null || true
          git commit -m "üìä Auto-update schedules $(date -u +'%Y-%m-%d %H:%M:%S') UTC" || true
      
      # 6. Push –∑–º—ñ–Ω–∏
      - name: Push changes
        if: always()
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: main
      
      # 7. –õ–æ–≥—É–≤–∞–Ω–Ω—è –ø–æ–º–∏–ª–æ–∫
      - name: Log on failure
        if: failure()
        env:
          TELEGRAM_LOG_CHANNEL_ID: ${{ secrets.TELEGRAM_LOG_CHANNEL_ID }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        run: |
          python -c "
          import os
          import asyncio
          from telegram import Bot
          
          message = '‚ùå Monitor failed at $(date -u)\\nCheck logs: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}'
          bot = Bot(token=os.getenv('TELEGRAM_BOT_TOKEN'))
          asyncio.run(bot.send_message(
              chat_id=os.getenv('TELEGRAM_LOG_CHANNEL_ID'),
              text=message
          ))
          "
